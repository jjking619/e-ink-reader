# 墨水屏阅读器

## 项目概述

这是一个集成了**眼动追踪翻页技术**的智能电子墨水屏阅读器项目，专门针对**Linux嵌入式平台**（Quectel-Pi-H1）设计。项目结合了C语言的底层硬件控制和Python的计算机视觉技术，实现了真正的"零手操"阅读体验。

## 🌟 核心功能特性

| 功能项 | 描述 |
|--------|------|
| **眼动控制翻页** | 通过检测眼球移动方向实现翻页，当观看到阅读器底部时，只需将目光移至屏幕顶部，即可触发翻页操作 |
| **智能息屏** | 检测不到人脸超过设定时间后自动息屏，保护隐私并节省电量 |
| **多语言支持** | 支持纯英文、纯中文（GB2312）、中英混合文本的正确渲染 |
| **自动排版** | 不裁剪字符，自动换行，支持跨页内容延续，中文首行缩进 |
| **页面记忆** | 支持返回前一页并保证像素级一致，精准记录阅读位置 |
| **多书管理** | 支持物理按键或长按切换不同书籍 |
| **高效刷新** | 采用局部刷新技术，减少闪烁并提高刷新速度 |

## 🛠️ 硬件配置要求

### 主要硬件
- **主控板**：Quectel-Pi-H1 
- **显示屏**：Waveshare 7.5" 黑白电子墨水屏（EPD_7in5_V2）
- **摄像头**：USB摄像头（用于眼动追踪）
- **输入设备**：至少两个物理按键（映射为 `/dev/input/eventX` 设备）

### 电子墨水屏连接引脚
| EPD 引脚 | BCM2835编码 | Board物理引脚序号 |
|----------|-------------|-------------------|
| VCC      | 3.3V        | 3.3V              |
| GND      | GND         | GND               |
| DIN      | MOSI        | 19                |
| CLK      | SCLK        | 23                |
| CS       | CE0         | 24                |
| DC       | 25          | 22                |
| RST      | 17          | 11                |
| BUSY     | 24          | 18                |
| PWR      | 18          | 12                |

## 📋 软件依赖

### 系统要求
- **Python版本**：Python 3.9~3.12

### 系统依赖
- **OpenCV**：用于图像处理
- **MediaPipe**：Google的机器学习框架，用于面部特征点检测
- **evdev**：Linux输入设备事件处理

## 🚀 快速部署指南

### 步骤 1：准备书籍文件
```bash
mkdir -p /home/pi/ebook-reader/src/tools/books
# 将您的 .txt 文件放入此目录，并确保编码为 GB2312
# Windows 用户操作路径：记事本 → 另存为 → 编码选"ANSI"（即 GB2312）
```

### 步骤 2：安装Python依赖
```bash
cd /home/pi/ebook-reader
pip install -r requirement.txt
```

### 步骤 3：编译C程序
```bash
cd /home/pi/ebook-reader/src/c
make CC=gcc EPD=epd7in5V2
```

> 如需交叉编译至ARM平台，请使用相应的交叉编译器，例如：
> ```bash
> make CC=aarch64-linux-gnu-gcc EPD=epd7in5V2
> ```

### 步骤 4：运行项目
```bash
cd /home/pi/ebook-reader
 ./startup.sh
```

## 👁️ 眼动控制使用方法

### 启动流程
1. 运行 [startup.sh](file:///home/pi/ebook-reader/startup.sh) 后，系统会同时启动眼动控制脚本和电子墨水屏程序
2. 摄像头会自动检测可用设备并开始监测用户的眼球运动
3. 初始化时间为4秒，期间请保持正常阅读姿势

### 翻页操作
- **向下翻页**：保持阅读姿势，向上看（抬头）触发下一页
- **向上翻页**：向后翻页需通过物理按键操作
- **翻页冷却**：两次翻页间有1秒冷却时间，防止误触

### 息屏/唤醒功能
- **自动息屏**：检测不到人脸4秒后自动发送息屏信号
- **自动唤醒**：重新检测到人脸时自动唤醒屏幕
- **事件清理**：唤醒时会清理息屏期间的输入事件，防止误翻页

## ⌨️ 物理按键功能

- **短按按键A**：向下翻页
- **短按按键B**：向上翻页
- **长按按键A**：切换到下一本书
- **长按按键B**：切换到上一本书

## 🔧 技术特点详解

### 眼动追踪算法
- 使用MediaPipe的人脸网格识别技术，精确定位眼部和虹膜关键点
- 实现指数平滑算法，减少画面抖动
- 70%的连续帧判断机制，防止误触发
- 自适应参考位置，适应不同的阅读姿势

### 电子墨水屏优化
- **局部刷新**：仅刷新文本内容和页码区域，保留标题栏不变
- **三层架构**：标题(header)、正文(content)、页码(footer)分区管理
- **中文优化**：支持中文首行缩进，符合阅读习惯
- **快速唤醒**：使用快速初始化模式，迅速从息屏恢复阅读状态

### 电源管理
- 智能息屏功能，无人阅读时自动进入低功耗模式
- 唤醒时仅刷新必要的UI元素，减少功耗
- 优化驱动延时，加快响应速度

## ⚠️ 注意事项

1. **文本编码**：TXT文件必须使用GB2312编码，否则中文可能出现乱码
2. **摄像头位置**：摄像头应放置在屏幕附近，确保能清晰拍摄到用户的面部
3. **光线条件**：在光线充足的环境下使用，确保摄像头能够清晰捕捉眼部特征
4. **权限设置**：程序需要访问摄像头和输入设备的权限，可能需要sudo运行
5. **硬件连接**：确保电子墨水屏正确连接到SPI接口，GPIO配置正确

## 🔍 故障排除

| 问题 | 解决方案 |
|------|----------|
| 摄像头无法打开 | 检查设备权限，使用 `ls /dev/video*` 确认设备节点存在 |
| 眼动控制无响应 | 检查摄像头是否被其他程序占用，确认MediaPipe安装正确 |
| 屏幕无显示或异常 | 检查SPI连接是否牢固，GPIO配置是否正确 |
| 中文显示乱码 | 确认TXT文件编码为GB2312 |
| 按键无效 | 使用 `cat /proc/bus/input/devices` 查找event设备并确认权限 |
| 编译失败 | 检查交叉编译工具链是否存在且路径正确 |

## 🚧 未来发展计划

| 计划项 | 状态 |
|--------|------|
| 更流畅的刷新动画优化 | 进行中 |
| 支持更多文本格式（PDF, EPUB） | 待开发 |
| 个性化阅读设置（字体大小、行间距） | 待开发 |
| 云端同步阅读进度 | 待开发 |
| 手势控制作为备用方案 | 待开发 |

